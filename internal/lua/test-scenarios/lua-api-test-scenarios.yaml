test_cases:
# GOAL: Verify that error conditions are properly detected and reported with meaningful error messages
#
# TEST SCENARIO: Execute various invalid subscription configurations → expect specific error messages
# NOTE: "Missing Callback" test is in Go code (bleapi_subscription_test.go)
#       because the YAML framework always generates callbacks and cannot test this Lua syntax error

  - name: "Error Handling: Callback Runtime Error"
    # GOAL: Verify that Lua subscription callback runtime errors are correctly captured
    #
    # TEST SCENARIO: Callback throws Lua error → error logged and sent to stderr → callback execution stops but subscription continues
    subscription:
      mode: EveryUpdate
      max_rate: 0ms
      services:
        - service: "1234"
          characteristics: ["5678"]
      callback_script: |

                error("Intentional test error in Lua callback")
    steps:
      - services:
          - service: "1234"
            values:
              - char: "5678"
                value: [0x01, 0x02]
    expected_errors:
      - "Intentional test error in Lua callback"

  - name: "Error Handling: Missing Services"
    subscription:
      mode: EveryUpdate
      max_rate: 0ms
      services: []
    expect_error_message: "no services specified in Lua subscription"

  - name: "Error Handling: Non-existent Service"
    subscription:
      mode: EveryUpdate
      max_rate: 0ms
      services:
        - service: "non-existent-service"
          characteristics: ["non-existent-char"]
    expect_error_message: "missing services: nonexistentservice"

  - name: "Error Handling: Non-existent Characteristic"
    subscription:
      mode: EveryUpdate
      max_rate: 0ms
      services:
        - service: "180d"
          characteristics: ["non-existent-char", "2a37"]
    expect_error_message: "missing characteristics: nonexistentchar"

# GOAL: Verify that EveryUpdate mode delivers each BLE notification immediately
#       as a separate callback with a single value per characteristic
#
# TEST SCENARIO: Send four notifications to the same characteristic → receive four separate callbacks → verify each contains the correct value
  - name: "EveryUpdate Subscription Test"
    subscription:
      mode: EveryUpdate
      services:
        - service: "1234"
          characteristics: ["5678"]
    allow_multi_value: true
    steps:
      - services:
          - service: "1234"
            values:
              - char: "5678"
                value: [0x58, 0x59, 0x5A]
              - char: "5678"
                value: [0x01, 0x02, 0x03]
              - char: "5678"
                value: [0x00, 0x5A]
              - char: "5678"
                value: [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]
    expected_json_output:
      - record:
          Values:
            "5678": [0x58, 0x59, 0x5A]
      - record:
          Values:
            "5678": [0x01, 0x02, 0x03]
      - record:
          Values:
            "5678": [0x00, 0x5A]
      - record:
          Values:
            "5678": [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]

# GOAL: Verify that Aggregated mode delivers only the latest value per characteristic
#       at ticker intervals (max_rate), discarding intermediate updates
#
# TEST SCENARIO: Send 2 values per step with 300ms ticker → receive only the latest value per tick → verify correct aggregation
  - name: "Aggregation Subscription Test"
    wait_after: 500ms
    subscription:
      mode: "Aggregated"
      max_rate: 300ms
      services:
        - service: "1234"
          characteristics: ["5678"]
    steps:
      - services:
          - service: "1234"
            values:
              - char: "5678"
                value: [0x58, 0x59, 0x5A]
              - char: "5678"
                value: [0x01, 0x02, 0x03]
        expected_json_output:
          - call_count: 1
            record:
              Values:
                "5678": [0x01, 0x02, 0x03]
      - services:
          - service: "1234"
            values:
              - char: "5678"
                value: [0x00, 0x5A]
              - char: "5678"
                value: [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]
        expected_json_output:
          - call_count: 2
            record:
              Values:
                "5678": [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]

# GOAL: Verify that Batched mode collects all values per characteristic between
#       ticker intervals and delivers them as arrays in a single callback
#
# TEST SCENARIO: Send 2 values per step with 300ms ticker → receive batched arrays of all values per tick → verify complete batching
  - name: "Batched Subscription Test"
    wait_after: 500ms
    subscription:
      mode: "Batched"
      max_rate: 300ms
      services:
        - service: "1234"
          characteristics: ["5678"]
    allow_multi_value: true
    steps:
      - services:
          - service: "1234"
            values:
              - char: "5678"
                value: [0x58, 0x59, 0x5A]
              - char: "5678"
                value: [0x01, 0x02, 0x03]
        expected_json_output:
          - call_count: 1
            record:
              BatchValues:
                "5678":
                  - [0x58, 0x59, 0x5A]
                  - [0x01, 0x02, 0x03]
      - services:
          - service: "1234"
            values:
              - char: "5678"
                value: [0x00, 0x5A]
              - char: "5678"
                value: [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]
        expected_json_output:
          - call_count: 2
            record:
              BatchValues:
                "5678":
                  - [0x00, 0x5A]
                  - [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]

# GOAL: Verify that EveryUpdate mode correctly handles subscriptions to multiple
#       characteristics and delivers separate notifications for each
#
# TEST SCENARIO: Subscribe to 2 characteristics → send value to each → receive two separate callbacks with correct characteristic data
  - name: "EveryUpdate Multi-Characteristic Subscription Test"
    subscription:
      mode: EveryUpdate
      services:
        - service: "180D"
          characteristics: ["2A37", "2A38"]
    steps:
      - services:
          - service: "180D"
            values:
              - char: "2A37"
                value: [0x58, 0x59, 0x5A]
              - char: "2A38"
                value: [0x01, 0x02, 0x03]
        expected_json_output:
          - call_count: 1
            record:
              Values:
                "2a37": [0x58, 0x59, 0x5A]
          - call_count: 2
            record:
              Values:
                "2a38": [0x01, 0x02, 0x03]

# GOAL: Verify that inspect.lua produces the expected text output format including parsed characteristic values
#
# TEST SCENARIO: Execute inspect.lua script → verify text format output with Appearance characteristic parser
  - name: "Inspect Device Test"
    script: "file:///examples/inspect.lua"
    wait_after: 500ms
    peripheral:
      - service: "1800"  # GAP Service
        characteristics:
          - uuid: "2a01"  # Appearance
            properties: "read"
            value: [0x40, 0x00]  # Phone (0x0040, little-endian)
      - service: "1234"
        characteristics:
          - uuid: "5678"
            properties: "read,notify"
      - service: "180d"
        characteristics:
          - uuid: "2a37"
            properties: "read,notify"
          - uuid: "2a38"
            properties: "read,notify"
      - service: "180f"
        characteristics:
          - uuid: "2a19"
            properties: "read,notify"
    expected_stdout: |
      Device info:
        ID: 00:00:00:00:00:01
        Address: 00:00:00:00:00:01
        Name: 00:00:00:00:00:01
        RSSI: 0
        Connectable: false
        Advertised Services: none
        Manufacturer Data: none
        Service Data: none
        GATT Services: 4

      [1] Service: 0x1234
        [1.1] Characteristic: 0x5678
            properties: Read, Notify

      [2] Service: Generic Access (0x1800)
        [2.1] Characteristic: Appearance (0x2a01)
            properties: Read
            value (hex):   4000
            value (ascii): @.
            value (parsed): Phone

      [3] Service: Heart Rate (0x180d)
        [3.1] Characteristic: Heart Rate Measurement (0x2a37)
            properties: Read, Notify
        [3.2] Characteristic: Body Sensor Location (0x2a38)
            properties: Read, Notify

      [4] Service: Battery Service (0x180f)
        [4.1] Characteristic: Battery Level (0x2a19)
            properties: Read, Notify

# GOAL: Verify that inspect.lua produce expected JSON output format
#
# TEST SCENARIO: Execute inspect.lua with ?format=json → verify JSON structure via expected_output
  - name: "Inspect Device Test (JSON format)"
    script: "file:///examples/inspect.lua?format=json"
    wait_after: 500ms
    peripheral:
      - service: "1234"
        characteristics:
          - uuid: "5678"
            properties: "read,notify"
      - service: "180d"
        characteristics:
          - uuid: "2a37"
            properties: "read,notify"
          - uuid: "2a38"
            properties: "read,notify"
      - service: "180f"
        characteristics:
          - uuid: "2a19"
            properties: "read,notify"
    expected_json_output:
      - device:
          id: "00:00:00:00:00:01"
          address: "00:00:00:00:00:01"
          name: "00:00:00:00:00:01"
          rssi: 0
          connectable: false
          advertised_services: []
          manufacturer_data: ""
          service_data: []
        services:
          - uuid: "1234"
            characteristics:
              - uuid: "5678"
                properties:
                  read:
                    value: 2
                    name: "Read"
                  notify:
                    value: 16
                    name: "Notify"
                descriptors: []
          - uuid: "180d"
            name: "Heart Rate"
            characteristics:
              - uuid: "2a37"
                name: "Heart Rate Measurement"
                properties:
                  read:
                    value: 2
                    name: "Read"
                  notify:
                    value: 16
                    name: "Notify"
                descriptors: []
              - uuid: "2a38"
                name: "Body Sensor Location"
                properties:
                  read:
                    value: 2
                    name: "Read"
                  notify:
                    value: 16
                    name: "Notify"
                descriptors: []
          - uuid: "180f"
            name: "Battery Service"
            characteristics:
              - uuid: "2a19"
                name: "Battery Level"
                properties:
                  read:
                    value: 2
                    name: "Read"
                  notify:
                    value: 16
                    name: "Notify"
                descriptors: []


