; PlatformIO Project Configuration File for ESP32-S3 BLE Test Peripheral
;
; This firmware simulates a comprehensive BLE peripheral device with multiple
; services and characteristics for testing and debugging purposes.
[platformio]

default_envs = um_feathers3

; ===================== Common Settings (All Environments) =====================
[env]
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
framework = arduino
platform = espressif32
platform_packages = toolchain-xtensa-esp32s3 @ 12.2.0  ; blex requires GCC >= 12.2

; Serial monitor settings
monitor_speed = 115200
monitor_filters =
    esp32_exception_decoder
    colorize
    time


; Upload settings
upload_speed = 921600

build_flags =
    # Suppress conflicting IRAM section warnings (xPortCanYield, xPortGetCoreID functions)
    -Wno-attributes

    # Fix RWX segments with proper ESP32-S3 cache sizes
    -Wl,-z,separate-code
    -Wl,--gc-sections

;     -Wno-error=address-of-packed-member  # ESP32 framework issue: prevent build failure while keeping warning visible

    ; Places literal pools (constants) next to the code that uses them
    ; rather than in a separate section. This improves performance.
    -mtext-section-literals

    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_RUNNING_CORE=1

build_unflags =
    -flto                  ; REMOVED: Link-time optimization - not compatible with toolchain
    -fprefetch-loop-arrays ; REMOVED: Unsupported by target architecture – causes compiler warning
    -std=gnu++11           ; REMOVED: Override with C++20 (gnu++2a) via cpp-build-flags.py


lib_deps =
     https://github.com/srgg/blex ; srgg/blex
    https://github.com/srgg/NimBLE-Arduino.git#feat/aggregate-format-2905 ; h2zero/NimBLE-Arduino

extra_scripts =
    pre:.pio/libdeps/${PIOENV}/blex/scripts/cpp-build-flags.py  ; C++20 flags for blex
    pre:.pio/libdeps/${PIOENV}/blex/scripts/version.py          ; Automated versioning from blex


; ===================== ESP32 =====================
[env:um_feathers3]
board = um_feathers3
; Build settings
;build_flags =
;	# Suppress conflicting IRAM section warnings (xPortCanYield, xPortGetCoreID functions)
;    -Wno-attributes
;
;    # Fix RWX segments with proper ESP32-S3 cache sizes
;    -Wl,-z,separate-code
;    -Wl,--gc-sections
;
;;     -Wno-error=address-of-packed-member  # ESP32 framework issue: prevent build failure while keeping warning visible
;
;    ; Places literal pools (constants) next to the code that uses them
;    ; rather than in a separate section. This improves performance.
;    -mtext-section-literals
;
;    -DCORE_DEBUG_LEVEL=4
;    -DBOARD_HAS_PSRAM
;    -DARDUINO_USB_CDC_ON_BOOT=1
;    -DARDUINO_RUNNING_CORE=1
;
;build_unflags =
;    -flto                  ; REMOVED: Link-time optimization - not compatible with toolchain
;    -fprefetch-loop-arrays ; REMOVED: Unsupported by target architecture – causes compiler warning
;