; PlatformIO Project Configuration File for ESP32-S3 BLE Test Peripheral
;
; This firmware simulates a comprehensive BLE peripheral device with multiple
; services and characteristics for testing and debugging purposes.
[platformio]

default_envs = um_feathers3

[env:um_feathers3]
platform = espressif32@6.10.0
board = um_feathers3
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
framework = arduino

; Automated versioning from Git
extra_scripts = pre:version.py

; Build settings
build_flags =
	# MODEL_NUMBER, FIRMWARE_VERSION, and SOFTWARE_REVISION are set by version.py

    # USE C++17
    -std=gnu++17

    # Suppress conflicting IRAM section warnings (xPortCanYield, xPortGetCoreID functions)
    -Wno-attributes

    # Fix RWX segments with proper ESP32-S3 cache sizes
    -Wl,-z,separate-code
    -Wl,--gc-sections

;     -Wno-error=address-of-packed-member  # ESP32 framework issue: prevent build failure while keeping warning visible

    ; Places literal pools (constants) next to the code that uses them
    ; rather than in a separate section. This improves performance.
    -mtext-section-literals

    -DCORE_DEBUG_LEVEL=4
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_RUNNING_CORE=1

    ; NimBLE stack configuration - increase stack sizes to prevent overflow
    -DCONFIG_BT_NIMBLE_HOST_TASK_STACK_SIZE=16384   ; Default 4096, increased for callbacks with logging
    -DCONFIG_BT_NIMBLE_ACL_BUF_SIZE=512            ; Default 255 (matches MTU 247 + header)
    -DCONFIG_BT_NIMBLE_ACL_BUF_COUNT=12            ; Default 12

build_unflags =
    -std=gnu++11           ; DO NOT USE C++11
    -flto                  ; REMOVED: Link-time optimization - not compatible with toolchain
    -fprefetch-loop-arrays ; REMOVED: Unsupported by target architecture â€“ causes compiler warning


; Serial monitor settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
; monitor_rts = 0
; monitor_dtr = 0

; Upload settings
upload_speed = 921600

; Library dependencies (pinned to exact versions for production stability)
lib_deps =
    adafruit/Adafruit LSM6DS@4.7.0
    adafruit/Adafruit LIS3MDL@1.2.4
    adafruit/Adafruit Unified Sensor@1.1.14
    h2zero/NimBLE-Arduino@2.1.3
    bblanchon/ArduinoJson@7.2.0