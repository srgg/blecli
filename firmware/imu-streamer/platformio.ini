; PlatformIO Project Configuration File for ESP32-S3 BLE Test Peripheral
;
; This firmware simulates a comprehensive BLE peripheral device with multiple
; services and characteristics for testing and debugging purposes.

[platformio]
default_envs = um_feathers3

; ===================== Common Settings (All Environments) =====================
[env]
platform = espressif32@6.10.0
board = um_feathers3
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
framework = arduino

; To check supported featurs ~/.platformio/packages/toolchain-xtensa-esp32s3/bin/xtensa-esp32s3-elf-g++ -std=c++2a -dM -E - < /dev/null
extra_scripts =
    pre:version.py          ; Automated versioning from Git
    pre:cpp-build-flags.py  ; C++-only compiler flags (avoids warnings on C files)

; Build flags (applied to both C and C++ files)
build_flags =
    ; Suppress conflicting IRAM section warnings (xPortCanYield, xPortGetCoreID functions)
    -Wno-attributes

    ; Fix RWX segments with proper ESP32-S3 cache sizes
    -Wl,-z,separate-code
    -Wl,--gc-sections

    ; Places literal pools (constants) next to the code that uses them
    ; rather than in a separate section. This improves performance.
    -mtext-section-literals

    ; Board configuration
    -DCORE_DEBUG_LEVEL=5
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_RUNNING_CORE=1

    ; NimBLE stack configuration - increase stack sizes to prevent overflow
    -DCONFIG_BT_NIMBLE_HOST_TASK_STACK_SIZE=16384   ; Default 4096, increased for callbacks with logging
    -DCONFIG_BT_NIMBLE_ACL_BUF_SIZE=512             ; Default 255 (matches MTU 247 + header)
    -DCONFIG_BT_NIMBLE_ACL_BUF_COUNT=12             ; Default 12

    ; NimBLE logging (verbose)
    -DCONFIG_NIMBLE_CPP_LOG_LEVEL=5                 ; 5=VERBOSE, 4=DEBUG, 3=INFO
    -DCONFIG_BT_NIMBLE_LOG_LEVEL=5

build_unflags =
    -std=gnu++11           ; DO NOT USE C++11 (C++20 set via cpp-build-flags.py)
    -flto                  ; REMOVED: Link-time optimization - not compatible with toolchain
    -fprefetch-loop-arrays ; REMOVED: Unsupported by target architecture â€“ causes compiler warning

; Serial monitor settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Upload settings
upload_speed = 921600

; Library dependencies (pinned to exact versions for production stability)
lib_deps =
    adafruit/Adafruit LSM6DS@4.7.0
    adafruit/Adafruit LIS3MDL@1.2.4
    adafruit/Adafruit Unified Sensor@1.1.14
    bblanchon/ArduinoJson@7.2.0
    https://github.com/srgg/NimBLE-Arduino.git#feat/aggregate-format-2905

; =================== Environment-Specific Settings ===================
[env:um_feathers3]
; This environment inherits all settings from [env]
; Add environment-specific overrides here if needed